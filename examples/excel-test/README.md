# Excel Plugin Test Examples

This directory contains test pipelines demonstrating the Excel WASM plugin functionality.

## Prerequisites

1. Build the Excel WASM plugin:
   ```bash
   cargo build -p conveyor-plugin-excel-wasm --target wasm32-wasip2 --release
   ```

2. Build Conveyor:
   ```bash
   cargo build --release
   ```

## Test Files

### Sample Data

- **sample.csv** - Test data with 5 records (ID, Name, Age, City, Salary)

### Pipeline Configurations

#### 1. `csv-to-excel.toml` - CSV to Excel Conversion

**Purpose:** Converts CSV file to Excel format

**Steps:**
1. Read `sample.csv`
2. Write to `output.xlsx` with sheet name "TestData"

**Run:**
```bash
../../target/release/conveyor run --config csv-to-excel.toml
```

**Output:** `output.xlsx` with 5 data rows

---

#### 2. `excel-to-stdout.toml` - Excel File Display

**Purpose:** Reads Excel file and displays contents in table format

**Steps:**
1. Read `output.xlsx` (sheet "TestData")
2. Display as formatted table to stdout

**Run:**
```bash
../../target/release/conveyor run --config excel-to-stdout.toml
```

**Expected Output:**
```
shape: (5, 5)
┌─────────┬───────────────┬─────┬──────┬──────────┐
│ Name    ┆ City          ┆ ID  ┆ Age  ┆ Salary   │
│ ---     ┆ ---           ┆ --- ┆ ---  ┆ ---      │
│ str     ┆ str           ┆ f64 ┆ f64  ┆ f64      │
╞═════════╪═══════════════╪═════╪══════╪══════════╡
│ Alice   ┆ New York      ┆ 1.0 ┆ 30.0 ┆ 75000.5  │
│ Bob     ┆ San Francisco ┆ 2.0 ┆ 25.0 ┆ 85000.0  │
│ Charlie ┆ Los Angeles   ┆ 3.0 ┆ 35.0 ┆ 65000.75 │
│ Diana   ┆ Seattle       ┆ 4.0 ┆ 28.0 ┆ 72000.0  │
│ Eve     ┆ Boston        ┆ 5.0 ┆ 32.0 ┆ 80000.25 │
└─────────┴───────────────┴─────┴──────┴──────────┘
```

---

#### 3. `excel-roundtrip.toml` - Excel Processing Pipeline

**Purpose:** Demonstrates full Excel workflow with data transformation

**Steps:**
1. Read `output.xlsx` (sheet "TestData")
2. Filter records where `Salary > 70000`
3. Write filtered results to `filtered.xlsx` (sheet "HighSalaries")

**Run:**
```bash
../../target/release/conveyor run --config excel-roundtrip.toml
```

**Output:** `filtered.xlsx` with 4 filtered rows (Alice, Bob, Diana, Eve)

---

#### 4. `verify-filtered.toml` - Verify Filtered Output

**Purpose:** Display filtered Excel file to verify correct filtering

**Steps:**
1. Read `filtered.xlsx` (sheet "HighSalaries")
2. Display as formatted table

**Run:**
```bash
../../target/release/conveyor run --config verify-filtered.toml
```

**Expected Output:**
```
shape: (4, 5)
┌──────────┬───────┬─────┬──────┬───────────────┐
│ Salary   ┆ Name  ┆ ID  ┆ Age  ┆ City          │
│ ---      ┆ ---   ┆ --- ┆ ---  ┆ ---           │
│ f64      ┆ str   ┆ f64 ┆ f64  ┆ str           │
╞══════════╪═══════╪═════╪══════╪═══════════════╡
│ 75000.5  ┆ Alice ┆ 1.0 ┆ 30.0 ┆ New York      │
│ 85000.0  ┆ Bob   ┆ 2.0 ┆ 25.0 ┆ San Francisco │
│ 72000.0  ┆ Diana ┆ 4.0 ┆ 28.0 ┆ Seattle       │
│ 80000.25 ┆ Eve   ┆ 5.0 ┆ 32.0 ┆ Boston        │
└──────────┴───────┴─────┴──────┴───────────────┘
```

Note: Charlie (Salary: 65000.75) is correctly filtered out.

---

## Quick Test Run

Execute all tests sequentially:

```bash
# From project root
cd examples/excel-test

# Test 1: CSV to Excel
../../target/release/conveyor run --config csv-to-excel.toml

# Test 2: Display original Excel
../../target/release/conveyor run --config excel-to-stdout.toml

# Test 3: Filter and create new Excel
../../target/release/conveyor run --config excel-roundtrip.toml

# Test 4: Verify filtered output
../../target/release/conveyor run --config verify-filtered.toml
```

## Expected Files After Tests

```
examples/excel-test/
├── README.md                  # This file
├── sample.csv                 # Input data
├── csv-to-excel.toml         # Test 1 config
├── excel-to-stdout.toml      # Test 2 config
├── excel-roundtrip.toml      # Test 3 config
├── verify-filtered.toml      # Test 4 config
├── output.xlsx               # Generated by Test 1 (5 rows)
└── filtered.xlsx             # Generated by Test 3 (4 rows)
```

## Cleaning Up

Remove generated Excel files:

```bash
rm -f output.xlsx filtered.xlsx
```

## Troubleshooting

### Plugin Not Found

```
Error: WASM plugin 'excel_wasm' not found
```

**Solution:** Build the plugin first:
```bash
cargo build -p conveyor-plugin-excel-wasm --target wasm32-wasip2 --release
```

### File Path Errors

```
Error: failed to find a pre-opened file descriptor
```

**Solution:** Run commands from project root, not from `examples/excel-test/` directory. The WASM sandbox only has access to the current working directory.

### Type Mismatch in Filter

```
Error: cannot compare string with numeric type (f64)
```

**Solution:** Use numeric values (not strings) for numeric comparisons:
```toml
# Correct
value = 70000

# Incorrect
value = "70000"
```

## Advanced Usage

### Custom Sheet Names

```toml
[stages.config]
path = "report.xlsx"
sheet = "Q4_Sales"      # Use specific sheet
```

### No Headers

```toml
[stages.config]
path = "data.xlsx"
has_headers = false     # First row is data, not headers
```

### Read Multiple Sheets

```toml
[[stages]]
id = "sheet1"
function = "excel.read"
[stages.config]
path = "workbook.xlsx"
sheet = "0"             # First sheet by index

[[stages]]
id = "sheet2"
function = "excel.read"
[stages.config]
path = "workbook.xlsx"
sheet = "1"             # Second sheet by index
```

## Performance Notes

- **Small Files (< 1MB):** Instant processing
- **Medium Files (1-10MB):** 1-5 seconds
- **Large Files (> 10MB):** May hit WASM memory limits

For large files, consider:
1. Splitting into smaller workbooks
2. Using CSV format instead
3. Processing one sheet at a time

## Related Documentation

- [Excel Plugin README](../../plugins-wasm/conveyor-plugin-excel-wasm/README.md) - Full plugin documentation
- [Conveyor README](../../README.md) - Main project documentation
